# ESP32-S3 固件合并工具使用说明

## 概述

这个工具可以将ESP32-S3项目编译后的分散固件文件合并为一个完整的固件文件，方便使用其他工具进行烧录。

## 固件结构分析

根据你的项目编译日志，固件包含以下部分：

| 地址 | 文件 | 说明 |
|------|------|------|
| 0x0 | bootloader/bootloader.bin | 引导程序 |
| 0x8000 | partition_table/partition-table.bin | 分区表 |
| 0xd000 | ota_data_initial.bin | OTA数据 |
| 0x10000 | srmodels/srmodels.bin | 语音识别模型 |
| 0xb0000 | brookesia_speaker.bin | 主应用程序 |
| 0x880000 | spiffs_data.bin | SPIFFS文件系统数据 |
| 0x92f000 | mmap_build/emotion/anim_emotion.bin | 表情动画 |
| 0xb0a000 | mmap_build/icon/anim_icon.bin | 图标动画 |
| 0xc4e000 | mmap_build/boot/anim_boot.bin | 启动动画 |

## 使用方法

### 方法1: 使用批处理脚本（推荐）

1. 确保项目已经编译完成（存在build目录）
2. 双击运行 `merge_firmware.bat`
3. 等待合并完成，输出文件为 `merged_firmware.bin`

### 方法2: 使用Python脚本

```bash
# 基本用法
python merge_firmware.py

# 指定输出文件名
python merge_firmware.py --output my_firmware.bin

# 指定build目录
python merge_firmware.py --build-dir my_build

# 指定闪存大小（如果使用不同大小的闪存）
python merge_firmware.py --flash-size 8388608  # 8MB
```

## 输出文件

合并完成后会生成 `merged_firmware.bin` 文件，这是一个16MB的完整固件文件，包含：

- 所有固件组件按正确地址排列
- 未使用的区域用0xFF填充
- 可以直接用于其他烧录工具

## 烧录参数

使用其他工具烧录时，请使用以下参数：

- **芯片类型**: ESP32-S3
- **闪存模式**: DIO
- **闪存频率**: 80MHz
- **闪存大小**: 16MB
- **起始地址**: 0x0

## 常见问题

### Q: 为什么需要合并固件？
A: ESP-IDF编译后生成多个分散的.bin文件，某些烧录工具需要单个完整的固件文件。

### Q: 合并后的文件有多大？
A: 固定为16MB，这是ESP32-S3的闪存大小。

### Q: 可以使用不同的闪存大小吗？
A: 可以，使用 `--flash-size` 参数指定，但需要确保所有固件组件都能容纳。

### Q: 合并失败怎么办？
A: 检查build目录是否存在，以及所有必需的固件文件是否完整。

## 技术细节

- 工具会按照地址顺序合并所有固件组件
- 未使用的闪存区域用0xFF填充（擦除状态）
- 支持自定义闪存大小和输出文件名
- 包含错误检查和文件存在性验证
